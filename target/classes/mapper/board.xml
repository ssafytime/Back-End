<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.time.ssafy.board.model.mapper.BoardMapper">

	<!-- List<BoardDto> boardList(Map<String, Integer> map) throws SQLException; 
		List<BoardRoomDto> boardRoomList(Map<String, Integer> map) throws SQLException; 
		void modifyRoom(BoardRoomDto boardRoomDto) throws SQLException; void deleteRoom(int 
		roomNo) throws SQLException; List<BoardDto> boardFindList(Map<String, Object> 
		map) throws SQLException; void addBoard(BoardDto boardDto) throws SQLException; 
		void addRoom(BoardRoomDto boardRoomDto) throws SQLException; void modifyBoard(BoardDto 
		boardDto) throws SQLException; void deleteBoard(int articleNo) throws SQLException; 
		BoardDto boardView(Map<String, Integer> map) throws SQLException; -->


	<!-- boardDto private int articleNo; private String userId; private int 
		roomNo; private String subject; private String content; private String registerTime; 
		private List<FileDto> fileDtos; -->

	<!-- boardRoomDto private int roomNo; private String userId; private String 
		roomName; private String registerTime; -->


	<!-- <resultMap type="boardDto" id="article"> <result column="article_no" 
		property="articleNo" /> <result column="user_id" property="userId" /> <result 
		column="room_no" property="roomNo" /> <result column="subject" property="subject" 
		/> <result column="content" property="content" /> <result column="register_time" 
		property="registerTime" /> </resultMap> <resultMap type="boardDto" id="viewArticle" 
		extends="article"> <collection property="fileInfos" column="article_no" javaType="list" 
		ofType="fileInfoDto" select="fileInfoList" /> </resultMap> <resultMap type="fileInfoDto" 
		id="file"> <result column="save_folder" property="saveFolder" /> <result 
		column="original_file" property="originalFile" /> <result column="save_file" 
		property="saveFile" /> </resultMap> -->
	<!-- *********************************************************** -->
	<!-- <select id="boardList" parameterType="map" resultType="boardRoomDto"> 
		select room_no, user_id, room_name, register_time from board_room_tb order 
		by room_no desc Limit #{start}, #{listsize} </select> <select id="getArticle" 
		parameterType="int" resultMap="viewArticle"> select b.article_no, b.user_id, 
		b.subject, b.content, b.hit, b.register_time, m.user_name from board b, members 
		m where b.user_id = m.user_id and b.article_no = #{articleNo} </select> <select 
		id="fileInfoList" resultMap="file"> select save_folder, original_file, save_file 
		from file_info where article_no = #{articleNo} </select> <update id="modifyArticle" 
		parameterType="boardDto"> update board set subject = #{subject}, content 
		= #{content} where article_no = #{articleNo} </update> <delete id="deleteFile" 
		parameterType="int"> delete from file_info where article_no = #{articleNo} 
		</delete> <delete id="deleteArticle" parameterType="int"> delete from board 
		where article_no = #{articleNo} </delete> <select id="boardFindList" parameterType="map" 
		resultMap="boardDto"> select article_no , user_id, room_no, subject, content, 
		register_time from board_tb <include refid="search"></include> order by article_no 
		desc </select> -->

	<sql id="boardsearch">
		<if test="word != null and word != ''">
			<if test="key == 'subject'">
				and bt.room_no = #{roomNo} and bt.subject like
				concat('%', #{word}, '%')
			</if>
		</if>
	</sql>

	<resultMap id="board" type="boardDto">
		<result column="article_no" property="articleNo" />
		<result column="user_id" property="userId" />
		<result column="room_no" property="roomNo" />
		<result column="subject" property="subject" />
		<result column="content" property="content" />
		<result column="register_time" property="registerTime" />
	</resultMap>

	<resultMap type="boardDto" id="viewBoard" extends="board">
		<collection property="fileInfos" column="article_no"
			javaType="list" ofType="fileDto" select="fileInfoList" />
	</resultMap>

	<select id="fileInfoList" resultMap="file">
		select save_folder,
		original_file, save_file
		from file_tb
		where article_no = #{articleNo}
	</select>

	<resultMap type="fileDto" id="file">
		<result column="save_folder" property="saveFolder" />
		<result column="original_file" property="originalFile" />
		<result column="save_file" property="saveFile" />
	</resultMap>
	
	<select id="boardList" parameterType="map" resultMap="board">
		select article_no, user_id, room_no, subject, content, register_time
		from board_tb
		where room_no = #{roomNo}
		order by article_no desc
 		limit #{start}, #{listsize}
	</select>

	<select id="boardFindList" parameterType="map"
		resultMap="board">
		select bt.article_no, bt.user_id, bt.room_no, bt.subject, bt.content,
		bt.register_time
		from board_room_tb br left join board_tb bt
		on br.room_no = bt.room_no
		<where>
			<include refid="boardsearch"></include>
		</where>
		order by article_no desc
		Limit #{start}, #{listsize}
	</select>


	<insert id="addBoard" parameterType="boardDto">
		insert into board_tb (user_id, room_no, subject, content,
		register_time)
		values (#{userId}, #{roomNo}, #{subject}, #{content},
		now())
		<selectKey resultType="int" keyProperty="articleNo"
			order="AFTER">
			select last_insert_id()
		</selectKey>
	</insert>
	
	<insert id="registerFile" parameterType="boardDto">
		insert into file_tb (article_no, save_folder, original_file,
		save_file)
		values
		<foreach collection="fileDtos" item="fileDto"
			separator=" , ">
			(#{articleNo}, #{fileDto.saveFolder},
			#{fileDto.originalFile}, #{fileDto.saveFile})
		</foreach>
	</insert>

	<!-- *************************************************************** -->
	<sql id="roomsearch">
		<if test="word != null and word != ''">
			<if test="key == 'roomName'">
				and room_name like concat('%', #{word}, '%')
			</if>
		</if>
	</sql>

	<resultMap id="roomlist" type="boardRoomDto">
		<result column="room_no" property="roomNo" />
		<result column="user_id" property="userId" />
		<result column="room_name" property="roomName" />
		<result column="register_time" property="registerTime" />
	</resultMap>

	<select id="boardRoomList" parameterType="map"
		resultMap="roomlist">
		select room_no, user_id, room_name, register_time
		from
		board_room_tb
		order by room_no desc
		Limit #{start}, #{listsize}
	</select>

	<insert id="addRoom" parameterType="boardRoomDto">
		insert into
		board_room_tb (user_id, room_name)
		values (#{userId}, #{roomName})
	</insert>



	<select id="roomFindList" parameterType="map"
		resultMap="roomlist">
		select room_no, user_id, room_name, register_time
		from board_room_tb
		<where>
			<include refid="roomsearch"></include>
		</where>
		order by room_no desc
	</select>

	<delete id="deleteRoom" parameterType="int">
		delete
		from board_room_tb
		where room_no = #{roomNo}
	</delete>

	<update id="modifyRoom" parameterType="boardRoomDto">
		update board_room_tb
		set
		room_name = #{roomName}
		where room_no = #{roomNo}
	</update>

</mapper>